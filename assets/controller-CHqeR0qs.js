const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.es-DU_n0kJk.js","assets/index-BiujmS5U.js","assets/index-23heATHV.css"])))=>i.map(i=>d[i]);
import{q as U,A as D,N as k,B as S,D as g,_ as z,E as Y,F as v,G as B,H as W,x as I,I as X,J as H,K as Q,L as Z,M as x,O,n as b,P as nn}from"./index-BiujmS5U.js";import{U as an,S as en}from"./rpc-DhZ09Qqk.js";const A="tw:connected-wallet-params";async function tn(n,i,e){if(!sn(e))throw new Error("given params are not stringifiable");const t=await n.getItem(A);let a;if(t){try{a=JSON.parse(t)}catch{a={}}a[i]=e}else a={[i]:e};n.setItem(A,U(a))}async function cn(n,i){const e=await n.getItem(A);if(!e)return null;try{const t=JSON.parse(e);return t!=null&&t[i]?t[i]:null}catch{return null}}function sn(n){try{return U(n),!0}catch{return!1}}let _=null;const P={lastUsedChainId:"tw.wc.lastUsedChainId",requestedChains:"tw.wc.requestedChains"};async function Cn(n,i,e,t,a){var T,q,M;const r=await F(n,e,a),l=n.walletConnect;let{onDisplayUri:c}=l||{};const s=await D(e);!c&&a&&(c=R=>{const L=s.mobile.native||s.mobile.universal;if(!L){a(R);return}const V=B(L,R).redirect;a(V)}),c&&r.events.addListener("display_uri",c);let h=l==null?void 0:l.optionalChains,d=n.chain;e==="global.safe"&&(h=K.map(g),d&&!h.includes(d)&&(d=void 0));const{chains:f,rpcMap:o}=hn({chain:d,client:n.client,optionalChains:h});await r.connect({...l!=null&&l.pairingTopic?{pairingTopic:l==null?void 0:l.pairingTopic}:{},optionalNamespaces:{[k]:{chains:f,events:["chainChanged","accountsChanged"],methods:["eth_sendTransaction","eth_signTransaction","eth_sign","personal_sign","eth_signTypedData","eth_signTypedData_v4","wallet_switchEthereumChain","wallet_addEthereumChain"],rpcMap:o}}}),G(f.map(E=>Number(E.split(":")[1])),t);const u=((T=f[0])==null?void 0:T.split(":")[1])||1,C=S(u),m=on(r.session,"eip155:1");if(!m)throw new Error("No accounts found on provider.");const p=n.chain&&n.chain.id===C?n.chain:g(C);if(n){const E={chain:n.chain,optionalChains:(q=n.walletConnect)==null?void 0:q.optionalChains,pairingTopic:(M=n.walletConnect)==null?void 0:M.pairingTopic};t&&tn(t,e,E)}return c&&r.events.removeListener("display_uri",c),J(m,p,r,i,t,n.client,s,a)}async function rn(n,i,e){var l,c,s,h,d,f;if(!n.session)throw new Error("No session found on provider.");const t=`eip155:${i.id}`,a=b(i.id);if($(n.session,t)){n.setDefaultChain(t);return}try{await y({provider:n,payload:{method:"wallet_switchEthereumChain",params:[{chainId:a}]},chain:t,walletInfo:e}),n.setDefaultChain(t);return}catch(o){if(((o==null?void 0:o.code)??((c=(l=o==null?void 0:o.data)==null?void 0:l.originalError)==null?void 0:c.code))===4001)throw new Error("User rejected chain switch")}const r=ln(n.session);if(!r)throw new Error("No routable chain to send wallet_addEthereumChain");try{await y({provider:n,payload:{method:"wallet_addEthereumChain",params:[{chainId:a,chainName:i.name,nativeCurrency:i.nativeCurrency,rpcUrls:[i.rpc],blockExplorerUrls:[((h=(s=i.blockExplorers)==null?void 0:s[0])==null?void 0:h.url)??""]}]},chain:r,walletInfo:e})}catch(o){throw((o==null?void 0:o.code)??((f=(d=o==null?void 0:o.data)==null?void 0:d.originalError)==null?void 0:f.code))===4001?new Error("User rejected add chain"):new Error(`Add chain failed: ${(o==null?void 0:o.message)||String(o)}`)}if(await y({provider:n,payload:{method:"wallet_switchEthereumChain",params:[{chainId:a}]},chain:t,walletInfo:e}),n.setDefaultChain(t),!$(n.session,t))throw new Error("Target chain still not enabled by wallet")}function N(n){var i;return(i=n==null?void 0:n.namespaces)==null?void 0:i.eip155}function $(n,i){var t;const e=N(n);return!!((t=e==null?void 0:e.accounts)!=null&&t.some(a=>a.startsWith(`${i}:`)))}function on(n,i){var a;const e=N(n),t=((a=e==null?void 0:e.accounts)==null?void 0:a.find(r=>r.startsWith(`${i}:`)))||(e==null?void 0:e.accounts[0]);return t?t.split(":")[2]??null:null}function ln(n){var e,t,a,r;const i=N(n);return((r=(a=(t=(e=i==null?void 0:i.accounts)==null?void 0:e[0])==null?void 0:t.split(":"))==null?void 0:a.slice(0,2))==null?void 0:r.join(":"))??null}async function mn(n,i,e,t,a){var u,C,w,m,p;const r=t?await cn(t,e):null,l=await D(e),c=await F(r?{chain:r.chain,client:n.client,walletConnect:{optionalChains:r.optionalChains,pairingTopic:r.pairingTopic}}:{client:n.client,walletConnect:{}},e,a);if(!c.session)throw await c.disconnect(),new Error("No wallet connect session found on provider.");const s=(w=(C=(u=c.session)==null?void 0:u.namespaces)==null?void 0:C[k])==null?void 0:w.accounts,h=(m=s==null?void 0:s[0])==null?void 0:m.split(":")[2];if(!h)throw new Error("No accounts found on provider.");const d=((p=n.chain)==null?void 0:p.id)||1,f=S(d),o=n.chain&&n.chain.id===f?n.chain:g(f);return J(h,o,c,i,t,n.client,l,a)}async function F(n,i,e){var h,d,f,o;if(_)return _;const t=await D(i),a=n.walletConnect,{UniversalProvider:r}=await z(async()=>{const{UniversalProvider:u}=await import("./index.es-DU_n0kJk.js");return{UniversalProvider:u}},__vite__mapDeps([0,1,2]));let l=a==null?void 0:a.optionalChains,c=n.chain;i==="global.safe"&&(l=K.map(g),c&&!l.includes(c)&&(c=void 0));const s=await r.init({metadata:{description:((h=a==null?void 0:a.appMetadata)==null?void 0:h.description)||v().description,icons:[((d=a==null?void 0:a.appMetadata)==null?void 0:d.logoUrl)||v().logoUrl],name:((f=a==null?void 0:a.appMetadata)==null?void 0:f.name)||v().name,url:((o=a==null?void 0:a.appMetadata)==null?void 0:o.url)||v().url,redirect:{native:t.mobile.native||void 0,universal:t.mobile.universal||void 0}},projectId:(a==null?void 0:a.projectId)||Y});if(s.events.setMaxListeners(Number.POSITIVE_INFINITY),i!=="walletConnect"){async function u(){var w,m,p,T;const C=((T=(p=(m=(w=s.session)==null?void 0:w.peer)==null?void 0:m.metadata)==null?void 0:p.redirect)==null?void 0:T.native)||t.mobile.native||t.mobile.universal;e&&C&&await e(C)}s.on("session_request_sent",u),s.events.addListener("disconnect",()=>{s.off("session_request_sent",u),_=null})}return _=s,s}function j({provider:n,address:i,client:e,chain:t,sessionRequestHandler:a,walletInfo:r}){return{address:I(i),async sendTransaction(c){const s=await y({provider:n,payload:{method:"eth_sendTransaction",params:[{data:c.data,from:I(i),gas:c.gas?b(c.gas):void 0,to:c.to,value:c.value?b(c.value):void 0}]},chain:`eip155:${c.chainId}`,walletInfo:r,sessionRequestHandler:a});return nn({chainId:c.chainId,client:e,contractAddress:c.to??void 0,gasPrice:c.gasPrice,transactionHash:s,walletAddress:I(i),walletType:"walletConnect"}),{transactionHash:s}},async signMessage({message:c}){const s=typeof c=="string"?x(c):c.raw instanceof Uint8Array?O(c.raw):c.raw;return y({provider:n,payload:{method:"personal_sign",params:[s,this.address]},chain:`eip155:${t.id}`,walletInfo:r,sessionRequestHandler:a})},async signTypedData(c){const s=X(c),{domain:h,message:d,primaryType:f}=s,o={EIP712Domain:H({domain:h}),...s.types};Q({domain:h,message:d,primaryType:f,types:o});const u=Z({domain:h??{},message:d,primaryType:f,types:o});return await y({provider:n,payload:{method:"eth_signTypedData_v4",params:[this.address,u]},chain:`eip155:${t.id}`,walletInfo:r,sessionRequestHandler:a})}}}async function y(n){var s,h,d,f;const{provider:i,payload:e,chain:t,walletInfo:a,sessionRequestHandler:r}=n,l=i.request(e,t),c=((f=(d=(h=(s=i.session)==null?void 0:s.peer)==null?void 0:h.metadata)==null?void 0:d.redirect)==null?void 0:f.native)||a.mobile.native||a.mobile.universal;return r&&c&&await r(c),l}function J(n,i,e,t,a,r,l,c){const s=j({address:n,chain:i,client:r,provider:e,sessionRequestHandler:c,walletInfo:l});async function h(){e.removeListener("accountsChanged",f),e.removeListener("chainChanged",o),e.removeListener("disconnect",d),await e.disconnect(),_=null}function d(){G([],a),a==null||a.removeItem(P.lastUsedChainId),h(),t.emit("disconnect",void 0)}function f(u){if(u[0]){const C=j({address:I(u[0]),chain:i,client:r,provider:e,sessionRequestHandler:c,walletInfo:l});t.emit("accountChanged",C),t.emit("accountsChanged",u)}else d()}function o(u){const C=g(S(u));t.emit("chainChanged",C),a==null||a.setItem(P.lastUsedChainId,String(u))}return e.on("accountsChanged",f),e.on("chainChanged",o),e.on("disconnect",d),e.on("session_delete",d),[s,i,h,u=>dn(e,u,l)]}async function dn(n,i,e){try{await rn(n,i,e)}catch(t){const a=typeof t=="string"?t:t==null?void 0:t.message;throw/user rejected request/i.test(a)?new an(t):new en(t)}}function G(n,i){i==null||i.setItem(P.requestedChains,U(n))}function hn(n){const i={},e=[];n.chain&&(i[n.chain.id]=W({chain:n.chain,client:n.client}),e.push(n.chain.id));const t=((n==null?void 0:n.optionalChains)||[]).slice(0,10);for(const a of t)i[a.id]=W({chain:a,client:n.client}),e.push(a.id);return e.includes(1)||(i[1]=g(1).rpc,e.push(1)),{chains:e.map(a=>`eip155:${a}`),rpcMap:i}}const K=[1,11155111,42161,43114,8453,1313161554,84532,56,42220,100,10,137,1101,324,534352];export{mn as autoConnectWC,Cn as connectWC};
